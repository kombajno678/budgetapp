<h1>Uploading .csv file</h1>


<div class="row m-1">
  <div class="col-12 col-md-6 mb-3 text-center">
    <h3>Need help getting file?</h3>
    <button mat-stroked-button
            color="secondary"
            (click)="onHelpButtonClick()">How do I export data?</button>
  </div>

  <div class="col-12 col-md-6 mb-3 text-center">
    <h3>Want to try with example file?</h3>
    <a mat-stroked-button
       color="secondary"
       [href]="exampleFilePath"
       target="_blank">Download example csv file</a>
  </div>


  <div class="col-8 mb-0 pb-0 pr-0">
    <form [formGroup]="myForm"
          class="w-100">


      <mat-form-field class="p-0">
        <div>
          <mat-toolbar>
            <!-- Display files names -->
            <input matInput
                   formControlName="fileAttr"
                   readonly />

            <!-- Browse Button -->

            <mat-icon>
              attach_file

            </mat-icon>
          </mat-toolbar>

          <!-- Fetch selected filed on change -->
          <input formControlName="file"
                 type="file"
                 id="file"
                 #fileInput
                 id="uploadFile"
                 (change)="onFileChange($event)"
                 name="uploadFile" />
        </div>
      </mat-form-field>

    </form>

  </div>


  <div class="col-4 text-center pb-3 pl-0">
    <button mat-flat-button
            class="w-100 h-100"
            color="primary"
            (click)="submit()"
            [disabled]="f.file.invalid">
            Submit
            <mat-icon>
              publish
            </mat-icon>
          </button>
  </div>

  <div class="col">
    <div *ngIf="f.file.touched && f.file.invalid">
      <div *ngIf="f.file.errors.required">
        File is required.
      </div>
    </div>
  </div>

</div>



<div class="row m-1"
     *ngIf="uploading">
  <div class="col"></div>
  <div class="col-auto">
    <mat-spinner>
    </mat-spinner>
    <span class="text-center p-3">
      uploading ...

    </span>

  </div>
  <div class="col"></div>
</div>


<ng-container *ngIf="(report$ | async) as r; else loading">
  <div class="row m-1">
    <div class="col-12">
      <h1>
        Please review generated operations.
      </h1>
      <p>
        You can make changes to them now. If you click cancel button, no changes will be made.
      </p>

    </div>

    <div class="col-sm-12 col-md-12 col-lg-12 p-3">
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            new scheduled operaions ({{r.ScheduledOperations.length}})
          </mat-panel-title>
          <mat-panel-description>
            Click to expand
          </mat-panel-description>
        </mat-expansion-panel-header>

        <ng-template matExpansionPanelContent>

          <cdk-virtual-scroll-viewport itemSize="48"
                                       minBufferPx="200"
                                       maxBufferPx="400"
                                       class="operations-viewport">
            <mat-list dense
                      class="w-100">
              <ng-container *cdkVirtualFor="let so of r.ScheduledOperations">
                <app-scheduled-operation-list-element [so]="so"
                                                      [compact]="true">

                </app-scheduled-operation-list-element>


              </ng-container>
            </mat-list>
          </cdk-virtual-scroll-viewport>

        </ng-template>

        <mat-action-row>
          <button mat-flat-button
                  (click)="saveScheduledOperations()">
            Save
          </button>
        </mat-action-row>
      </mat-expansion-panel>
    </div>

    <div class="col-sm-12 col-md-12 col-lg-12 p-3">

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            new categories ({{r.Categories.length}})
          </mat-panel-title>
          <mat-panel-description>
            Click to expand
          </mat-panel-description>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>

          <cdk-virtual-scroll-viewport itemSize="48"
                                       minBufferPx="200"
                                       maxBufferPx="400"
                                       class="operations-viewport">
            <mat-list dense
                      class="w-100">
              <ng-container *cdkVirtualFor="let cat of r.Categories">
                <app-category-list-element [cat]="cat"
                                           [compact]="false"
                                           (onDelete)="deleteCategory($event)"
                                           (onModify)="modifyCategory($event)">
                  ...
                </app-category-list-element>
              </ng-container>
            </mat-list>
          </cdk-virtual-scroll-viewport>




        </ng-template>
      </mat-expansion-panel>

    </div>

    <div class="col-sm-12 col-md-12 col-lg-12 p-3">
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            new operations ({{r.Operations.length}})
          </mat-panel-title>
          <mat-panel-description>
            Click to expand
          </mat-panel-description>
        </mat-expansion-panel-header>
        <ng-template matExpansionPanelContent>
          <cdk-virtual-scroll-viewport itemSize="48"
                                       minBufferPx="200"
                                       maxBufferPx="400"
                                       class="operations-viewport">

            <mat-list dense
                      class="w-100">

              <ng-container *cdkVirtualFor="let op of r.Operations;templateCacheSize: 20">

                <app-operation-list-element [op]="op"
                                            [compact]="true"
                                            (onDelete)="deleteOperation($event)"
                                            (onModify)="modifyOperation($event)"
                                            class="w-100">

                </app-operation-list-element>


              </ng-container>

            </mat-list>

          </cdk-virtual-scroll-viewport>
        </ng-template>
        <mat-action-row>
          <button mat-flat-button
                  (click)="saveOperations()">
            Save
          </button>
        </mat-action-row>

      </mat-expansion-panel>


    </div>




  </div>

  <div class="row m-1">

    <div class="col">

    </div>
    <div class="col-auto">
      <button mat-flat-button
              (click)="onCancel()">
        Cancel
      </button>
    </div>
    <div class="col-auto">
      <button mat-flat-button
              (click)="onSave()"
              color="primary">
        Save
      </button>
    </div>

  </div>


</ng-container>

<ng-template #loading>





  <ng-container *ngIf="!success; else successMsg">

    <ng-container *ngIf="report">
      <div class="row m-1">
        <div class="col"></div>
        <div class="col-auto">
          <mat-progress-spinner [value]="uploadProgress"
                                [mode]="uploadBarMode">

          </mat-progress-spinner>

        </div>
        <div class="col"></div>
      </div>
    </ng-container>



  </ng-container>

  <ng-template #successMsg>
    <h1>
      Import successflul!
    </h1>
    <a mat-flat-button
       color="primary"
       href="/">Go to home page</a>
  </ng-template>




</ng-template>